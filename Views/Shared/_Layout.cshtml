@using System.Text.Json
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpAccessor

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewData["Title"] - BBURGER Clone</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="~/css/site.css" />

    <style>
        /* small in-layout styles */
        body {
            font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            background: #f6f7fb;
            color: #111;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 16px;
        }

        header.navbar {
            background: #fff;
            border-bottom: 1px solid rgba(0,0,0,0.04);
            padding: 12px 0;
            position: sticky;
            top: 0;
            z-index: 40;
        }

        .logo {
            font-weight: 800;
            color: #111;
            text-decoration: none;
            font-size: 20px;
        }

        .main-nav a {
            margin: 0 10px;
            color: #333;
            text-decoration: none;
            font-weight: 600;
        }

        .nav-actions .checkout-btn {
            background: #f44336;
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 700;
            text-decoration: none;
        }

        .cart-badge {
            background: #fff;
            color: #f44336;
            padding: 2px 8px;
            border-radius: 999px;
            margin-left: 8px;
            font-weight: 700;
        }

        footer.footer {
            margin-top: 36px;
            padding: 22px 0;
            background: transparent;
            color: #444;
        }
    </style>
</head>
<body>
    @{
        // Server-side attempt to calculate cart count for initial render (safe)
        int cartCount = 0;
        try
        {
            var session = HttpAccessor?.HttpContext?.Session;
            var cartJson = session?.GetString("Cart");
            if (!string.IsNullOrEmpty(cartJson))
            {
                using var doc = JsonDocument.Parse(cartJson);
                if (doc.RootElement.ValueKind == JsonValueKind.Array)
                {
                    foreach (var el in doc.RootElement.EnumerateArray())
                    {
                        if (el.TryGetProperty("Quantity", out var qtyProp) && qtyProp.ValueKind == JsonValueKind.Number)
                        {
                            if (qtyProp.TryGetInt32(out var q)) cartCount += q;
                        }
                    }
                }
            }
        }
        catch { cartCount = 0; }
    }

    <header class="navbar">
        <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
            <div style="display:flex;align-items:center;gap:12px;">
                <a asp-controller="Home" asp-action="Index" class="logo">BBURGER <span style="color:#f44336;margin-left:6px;font-weight:700;">CLONE</span></a>
            </div>

            <nav class="main-nav" role="navigation" style="flex:1;text-align:center;">
                <a asp-controller="Home" asp-action="Index">Home</a>
                <a asp-controller="Offers" asp-action="Index">Offers</a>
                <a asp-controller="Home" asp-action="Index">Menu</a>
                <!-- Contact removed -->
            </nav>

            <div class="nav-actions" style="display:flex;align-items:center;gap:12px;">
                <form class="search-form" role="search" method="get" action="/Home/Index" style="display:flex;">
                    <input name="q" class="search-input" placeholder="Search burgers, offers..." style="padding:8px;border-radius:8px;border:1px solid #eee;" />
                </form>

                <a id="cart-link" asp-controller="Cart" asp-action="Index" title="View cart" style="display:flex;align-items:center;gap:8px;text-decoration:none;color:inherit;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M7 4h-2l-1 2h2l2 9h8l2-7h-11" stroke="#111" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                    <span>Cart</span>
                    <span id="cart-badge" class="cart-badge">@cartCount</span>
                </a>

                <a id="header-checkout-btn" class="checkout-btn" asp-controller="Checkout" asp-action="Payment" role="button" title="Checkout">Checkout</a>
            </div>
        </div>
    </header>

    <main class="content container" style="margin-top:18px;min-height:60vh;">
        @RenderBody()
    </main>

    <footer class="footer">
        <div class="container" style="display:flex;gap:20px;justify-content:space-between;align-items:flex-start;">
            <div>
                <h3 style="margin:0 0 8px 0;">BBURGER Clone</h3>
                <p style="margin:0 0 8px 0;">Delicious burgers delivered fast & fresh.</p>
                <p class="muted-note" style="color:#666;margin:0;">Open daily 10:00 — 23:00</p>
            </div>

            <div>
                <h4 style="margin:0 0 8px 0;">Quick links</h4>
                <ul style="list-style:none;padding:0;margin:0;">
                    <li><a asp-controller="Home" asp-action="Index">Home</a></li>
                    <li><a asp-controller="Offers" asp-action="Index">Offers</a></li>
                    <li><a asp-controller="Cart" asp-action="Index">Cart</a></li>
                </ul>
            </div>

            <div>
                <h4 style="margin:0 0 8px 0;">Contact</h4>
                <div style="color:#444;">
                    <div><strong>Email:</strong> <a href="mailto:support@bburgerclone.com">support@bburgerclone.com</a></div>
                    <div style="margin-top:6px;"><strong>Phone:</strong> <a href="tel:+919876543210">+91 98765 43210</a></div>
                </div>
            </div>
        </div>

        <div class="container" style="display:flex;justify-content:space-between;padding-top:12px;border-top:1px solid rgba(0,0,0,0.04);margin-top:18px;">
            <div>© @DateTime.Now.Year BBURGER Clone</div>
            <div style="color:#666;">Contactless delivery • Secure payments</div>
        </div>
    </footer>

    <script>
        (function () {
            function updateCartCount() {
                fetch('/Cart/GetCount')
                    .then(r => { if (!r.ok) return null; return r.json(); })
                    .then(json => { if (json && typeof json.count === 'number') { var b = document.getElementById('cart-badge'); if (b) b.innerText = json.count; } })
                    .catch(()=>{});
            }
            document.addEventListener('DOMContentLoaded', updateCartCount);
            window.refreshCart = updateCartCount;
        })();
    </script>

    @RenderSection("Scripts", required: false)
</body>
</html>
s