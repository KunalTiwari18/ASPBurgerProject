@model List<BBURGERClone.Models.CartItem>

@{
    ViewData["Title"] = "Payment";
    // Defensive: ensure items list is never null
    var items = Model ?? new List<BBURGERClone.Models.CartItem>();
    decimal subtotal = 0m;
    foreach (var it in items)
    {
        // LineTotal may depend on Product — calculate safely
        var price = (it?.Product?.Price) ?? 0m;
        subtotal += price * (it?.Quantity ?? 0);
    }
    var delivery = ViewBag.Delivery ?? 39.00m;
    var total = subtotal + delivery;
}

<div class="container" style="padding:18px;">
    <h1>Checkout</h1>

    @if (!items.Any())
    {
        <div class="alert warning">Your cart is empty. <a asp-controller="Home" asp-action="Index">Browse menu</a></div>
    }
    else
    {
        <div style="display:flex;gap:18px;flex-wrap:wrap;">
            <div style="flex:1;min-width:320px;">
                <h3>Choose payment method</h3>

                <div style="margin:8px 0 14px;">
                    <label><input type="radio" name="method" value="card" checked /> Card</label>
                    <label style="margin-left:12px;"><input type="radio" name="method" value="qr" /> QR (UPI)</label>
                    <label style="margin-left:12px;"><input type="radio" name="method" value="sim" /> Simulated</label>
                </div>

                <div id="card-block">
                    <h4>Card (Stripe)</h4>
                    <form id="cardForm" onsubmit="return false;">
                        @Html.AntiForgeryToken()
                        <div><label>Name</label><input id="cardName" /></div>
                        <div><label>Email</label><input id="cardEmail" type="email" /></div>
                        <div style="margin-top:10px;">
                            <button id="cardPayBtn" class="btn">Pay with Card</button>
                        </div>
                    </form>
                </div>

                <div id="qr-block" style="display:none;">
                    <h4>Pay by QR</h4>
                    <div id="qrArea">QR will appear here.</div>
                    <div style="margin-top:8px;">
                        <label>Payer name</label>
                        <input id="payerName" />
                    </div>
                    <form id="confirmQrForm" asp-action="ConfirmQr" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" id="hiddenPayerName" name="payerName" />
                        <input type="hidden" id="hiddenTxRef" name="transactionRef" />
                        <button id="confirmQrBtn" class="btn" type="submit">I Paid — Confirm</button>
                    </form>
                </div>

                <div id="sim-block" style="display:none;">
                    <h4>Simulated</h4>
                    <form asp-action="ConfirmSimulated" method="post">
                        @Html.AntiForgeryToken()
                        <div><label>Name</label><input name="customerName" required /></div>
                        <div><label>Address</label><input name="address" required /></div>
                        <div><label>Email</label><input name="email" type="email" required /></div>
                        <div style="margin-top:10px;"><button class="btn">Pay (Simulated)</button></div>
                    </form>
                </div>

                <div id="paymentMessage" style="margin-top:12px;color:#b00;"></div>
            </div>

            <aside style="width:320px;">
                <div class="summary-card">
                    <h3>Order Summary</h3>
                    <ul style="padding-left:0;list-style:none;">
                        @foreach (var it in items)
                        {
                            var name = it?.Product?.Name ?? "(product missing)";
                            var qty = it?.Quantity ?? 0;
                            var price = it?.Product?.Price ?? 0m;
                            var line = price * qty;
                            <li style="margin-bottom:8px;">
                                <div><strong>@name</strong></div>
                                <div class="muted">Qty: @qty</div>
                                <div>Line: ₹@String.Format("{0:0.00}", line)</div>
                            </li>
                        }
                    </ul>

                    <div>Subtotal: <strong>₹@String.Format("{0:0.00}", subtotal)</strong></div>
                    <div>Delivery: <strong>₹@String.Format("{0:0.00}", delivery)</strong></div>
                    <div style="font-weight:700;margin-top:6px;">Total: <strong>₹@String.Format("{0:0.00}", total)</strong></div>
                </div>
            </aside>
        </div>
    }
</div>

@section Scripts {
    <script>
        (function(){
            // small client-side UI logic (same as before) — keep simple and defensive
            var radios = document.querySelectorAll('input[name="method"]');
            var card = document.getElementById('card-block');
            var qr = document.getElementById('qr-block');
            var sim = document.getElementById('sim-block');

            radios.forEach(function(r){
                r.addEventListener('change', function(){
                    card.style.display = this.value === 'card' ? 'block' : 'none';
                    qr.style.display = this.value === 'qr' ? 'block' : 'none';
                    sim.style.display = this.value === 'sim' ? 'block' : 'none';
                });
            });
        })();
    </script>
}
